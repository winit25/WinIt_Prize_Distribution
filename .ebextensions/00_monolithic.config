# ============================================================================
# MONOLITHIC ELASTIC BEANSTALK CONFIGURATION
# ============================================================================
# This single file consolidates all deployment configurations:
# - Package installation
# - Environment variables
# - PHP settings
# - Nginx configuration
# - Storage directory creation
# - Permissions
# - Cache management
# - Database migrations
# ============================================================================

# ----------------------------------------------------------------------------
# 1. PACKAGES - Install required system packages
# ----------------------------------------------------------------------------
packages:
  yum:
    git: []
    unzip: []

# ----------------------------------------------------------------------------
# 2. ENVIRONMENT VARIABLES - Set application and composer settings
# ----------------------------------------------------------------------------
option_settings:
  # Application environment
  aws:elasticbeanstalk:application:environment:
    APP_ENV: production
    APP_DEBUG: false
    LOG_CHANNEL: stderr
    SESSION_DRIVER: database
    CACHE_DRIVER: database
    QUEUE_CONNECTION: database
    COMPOSER_HOME: /root
    COMPOSER_IGNORE_PLATFORM_REQS: 1
    COMPOSER_PROCESS_TIMEOUT: "900"
  
  # PHP configuration
  aws:elasticbeanstalk:container:php:phpini:
    document_root: /public
    memory_limit: 512M
  
  # Deployment settings
  aws:elasticbeanstalk:command:
    DeploymentPolicy: AllAtOnce
    Timeout: "900"

# ----------------------------------------------------------------------------
# 3. NGINX CONFIGURATION - Laravel routing support
# ----------------------------------------------------------------------------
files:
  "/etc/nginx/conf.d/elasticbeanstalk/php.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      root /var/app/current/public;
      index index.php index.html index.htm;
      
      location / {
          try_files $uri $uri/ /index.php?$query_string;
      }

      location ~ \.php$ {
          fastcgi_pass unix:/run/php-fpm/www.sock;
          fastcgi_index index.php;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          include fastcgi_params;
      }

      location ~ /\.(?!well-known).* {
          deny all;
      }

# ----------------------------------------------------------------------------
# 4. PRE-DEPLOYMENT COMMANDS - Run BEFORE application deployment (as root)
# ----------------------------------------------------------------------------
commands:
  # Create storage directories in staging BEFORE composer runs
  00_create_staging_storage:
    command: |
      echo "Creating storage directories in staging (pre-deployment)..."
      mkdir -p /var/app/staging/storage/framework/{views,sessions,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
      echo "✓ Staging storage directories created"
    ignoreErrors: true
  
  # Test nginx configuration
  01_test_nginx:
    command: "nginx -t || true"
    ignoreErrors: true

# ----------------------------------------------------------------------------
# 5. POST-DEPLOYMENT CONTAINER COMMANDS - Run AFTER deployment (as webapp)
# ----------------------------------------------------------------------------
container_commands:
  # Create storage directories in current (where app runs)
  01_create_current_directories:
    command: |
      cd /var/app/current
      echo "Creating storage directories in current..."
      # Create base directories first
      mkdir -p storage
      mkdir -p storage/framework
      mkdir -p bootstrap
      # Create subdirectories
      mkdir -p storage/framework/views
      mkdir -p storage/framework/sessions
      mkdir -p storage/framework/cache
      mkdir -p storage/logs
      mkdir -p bootstrap/cache
      # Ensure directories exist and are writable
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
      # Verify creation
      test -d storage/framework/views && echo "✓ Views directory exists" || echo "✗ Views directory missing"
      test -w storage/framework/views && echo "✓ Views directory writable" || echo "✗ Views directory not writable"
      echo "✓ Current storage directories created"
    ignoreErrors: true
    
  # Fix permissions for storage and cache directories
  02_fix_permissions:
    command: |
      cd /var/app/current
      echo "Setting permissions..."
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
      chmod -R 755 public || true
      chown -R webapp:webapp public || true
      echo "✓ Permissions set"
    ignoreErrors: true
    
  # Clear all Laravel caches
  03_clear_caches:
    command: |
      cd /var/app/current
      echo "Clearing Laravel caches..."
      rm -rf storage/framework/views/*.php 2>/dev/null || true
      php artisan view:clear || true
      php artisan config:clear || true
      php artisan route:clear || true
      php artisan cache:clear || true
      php artisan optimize:clear || true
      chmod -R 775 storage/framework/views || true
      chown -R webapp:webapp storage/framework/views || true
      echo "✓ Caches cleared"
    leader_only: true
    
  # Discover packages
  04_package_discover:
    command: "cd /var/app/current && php artisan package:discover --ansi || true"
    leader_only: true
    
  # Cache configuration (after clearing)
  05_cache_config:
    command: "cd /var/app/current && php artisan config:cache || true"
    leader_only: true
    
  # Run database migrations
  06_run_migrations:
    command: |
      cd /var/app/current
      echo "Running database migrations..."
      php artisan migrate:status > /dev/null 2>&1 || php artisan migrate:install --force || true
      php artisan migrate --force || true
      echo "✓ Migrations completed"
    leader_only: true
