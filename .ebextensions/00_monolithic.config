option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
    COMPOSER_IGNORE_PLATFORM_REQS: 1

# Commands run BEFORE deployment (as root)
commands:
  # 1. Create storage directories in staging BEFORE composer runs
  00_create_staging_storage:
    command: |
      mkdir -p /var/app/staging/storage/framework/{views,sessions,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
    ignoreErrors: true

# Container commands run AFTER deployment (as webapp user)
container_commands:
  # 1. Create storage directories in current
  01_create_directories:
    command: |
      cd /var/app/current
      mkdir -p storage/framework/views
      mkdir -p storage/framework/sessions
      mkdir -p storage/framework/cache
      mkdir -p storage/logs
      mkdir -p bootstrap/cache
    ignoreErrors: true
    
  # 2. Fix permissions
  02_fix_permissions:
    command: |
      cd /var/app/current
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
    ignoreErrors: true
    
  # 3. Clear all caches
  03_clear_caches:
    command: |
      cd /var/app/current
      rm -rf storage/framework/views/*.php 2>/dev/null || true
      php artisan view:clear || true
      php artisan config:clear || true
      php artisan route:clear || true
      php artisan cache:clear || true
      php artisan optimize:clear || true
      chmod -R 775 storage/framework/views || true
      chown -R webapp:webapp storage/framework/views || true
    leader_only: true
    
  # 4. Run package discovery
  04_package_discover:
    command: "cd /var/app/current && php artisan package:discover --ansi || true"
    leader_only: true
    
  # 5. Cache config (after clearing)
  05_cache_config:
    command: "cd /var/app/current && php artisan config:cache || true"
    leader_only: true
    
  # 6. Run migrations
  06_run_migrations:
    command: |
      cd /var/app/current
      php artisan migrate:status > /dev/null 2>&1 || php artisan migrate:install --force || true
      php artisan migrate --force || true
    leader_only: true

