option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
    
commands:
  00_ensure_staging_storage:
    command: |
      # Ensure directories exist before any PHP code runs
      # Use 777 permissions during deployment to avoid permission issues
      mkdir -p /var/app/staging/storage/framework/{sessions,views,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
    ignoreErrors: true
    
container_commands:
  00_package_discover:
    command: "php artisan package:discover --ansi || true"
    leader_only: true
  01_create_staging_directories:
    command: |
      mkdir -p /var/app/staging/storage/framework/{sessions,views,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
    ignoreErrors: true
  02_create_current_directories:
    command: |
      mkdir -p storage/framework/{sessions,views,cache} storage/logs bootstrap/cache
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
    ignoreErrors: true
  03_permissions:
    command: |
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
    ignoreErrors: true
  04_config_cache:
    command: "php artisan config:cache || true"
    leader_only: true
