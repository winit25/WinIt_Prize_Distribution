option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
    COMPOSER_IGNORE_PLATFORM_REQS: 1
    
commands:
  00_ensure_staging_storage:
    command: |
      # Ensure directories exist before any PHP code runs
      # Use 777 permissions during deployment to avoid permission issues
      # Create base directories first
      mkdir -p /var/app/staging/storage
      mkdir -p /var/app/staging/storage/framework
      mkdir -p /var/app/staging/bootstrap
      # Create subdirectories
      mkdir -p /var/app/staging/storage/framework/sessions
      mkdir -p /var/app/staging/storage/framework/views
      mkdir -p /var/app/staging/storage/framework/cache
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      # Set permissions
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
      # Verify views directory exists and is writable
      if [ ! -d "/var/app/staging/storage/framework/views" ]; then
        mkdir -p /var/app/staging/storage/framework/views
        chmod 777 /var/app/staging/storage/framework/views
        chown webapp:webapp /var/app/staging/storage/framework/views || true
      fi
      # Final check
      test -d /var/app/staging/storage/framework/views && test -w /var/app/staging/storage/framework/views && echo "✓ Views directory exists and is writable" || echo "✗ Views directory check failed"
    ignoreErrors: true
    
container_commands:
  00_package_discover:
    command: "php artisan package:discover --ansi || true"
    leader_only: true
  01_create_staging_directories:
    command: |
      mkdir -p /var/app/staging/storage/framework/{sessions,views,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
    ignoreErrors: true
  02_create_current_directories:
    command: |
      cd /var/app/current
      # Create base directories first
      mkdir -p storage
      mkdir -p storage/framework
      mkdir -p bootstrap
      # Create subdirectories
      mkdir -p storage/framework/sessions
      mkdir -p storage/framework/views
      mkdir -p storage/framework/cache
      mkdir -p storage/logs
      mkdir -p bootstrap/cache
      # Set permissions
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
      # Verify views directory exists and is writable
      if [ ! -d "storage/framework/views" ]; then
        mkdir -p storage/framework/views
        chmod 775 storage/framework/views
        chown webapp:webapp storage/framework/views || true
      fi
      test -d storage/framework/views && test -w storage/framework/views && echo "✓ Current views directory exists and is writable" || echo "✗ Views directory check failed"
      # Also ensure staging directories exist (in case Laravel resolves there)
      mkdir -p /var/app/staging/storage/framework/views 2>/dev/null || true
      chmod -R 777 /var/app/staging/storage 2>/dev/null || true
    ignoreErrors: true
  03_permissions:
    command: |
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
    ignoreErrors: true
  04_clear_caches:
    command: |
      cd /var/app/current
      php artisan view:clear || true
      php artisan config:clear || true
      php artisan route:clear || true
      php artisan cache:clear || true
    leader_only: true
  05_config_cache:
    command: |
      cd /var/app/current
      php artisan config:cache || true
    leader_only: true
  06_run_migrations:
    command: |
      php artisan migrate:status > /dev/null 2>&1 || php artisan migrate:install --force || true
      php artisan migrate --force || true
    leader_only: true
