option_settings:
  aws:elasticbeanstalk:application:environment:
    COMPOSER_HOME: /root
    COMPOSER_IGNORE_PLATFORM_REQS: 1

# Commands run BEFORE the application is deployed
commands:
  00_create_storage_directories:
    command: |
      # Create storage directories in staging (where composer runs)
      mkdir -p /var/app/staging/storage/framework/{views,sessions,cache}
      mkdir -p /var/app/staging/storage/logs
      mkdir -p /var/app/staging/bootstrap/cache
      chmod -R 777 /var/app/staging/storage /var/app/staging/bootstrap/cache
      chown -R webapp:webapp /var/app/staging/storage /var/app/staging/bootstrap/cache || true
    ignoreErrors: true

# Container commands run AFTER the application is deployed
container_commands:
  01_create_directories:
    command: |
      cd /var/app/current
      mkdir -p storage/framework/views
      mkdir -p storage/framework/sessions
      mkdir -p storage/framework/cache
      mkdir -p storage/logs
      mkdir -p bootstrap/cache
    ignoreErrors: true
    
  02_fix_permissions:
    command: |
      cd /var/app/current
      chmod -R 775 storage bootstrap/cache
      chown -R webapp:webapp storage bootstrap/cache || true
    ignoreErrors: true
    
  03_clear_caches:
    command: |
      cd /var/app/current
      # Remove all compiled views to force recompilation
      rm -rf storage/framework/views/*.php 2>/dev/null || true
      # Clear all caches
      php artisan view:clear || true
      php artisan config:clear || true
      php artisan route:clear || true
      php artisan cache:clear || true
      php artisan optimize:clear || true
      # Ensure views directory is writable
      chmod -R 775 storage/framework/views || true
      chown -R webapp:webapp storage/framework/views || true
    leader_only: true
    
  04_cache_config:
    command: |
      cd /var/app/current
      php artisan config:cache || true
    leader_only: true

