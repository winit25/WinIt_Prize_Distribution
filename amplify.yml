version: 1
frontend:
  phases:
    preBuild:
      commands:
        - '# Check PHP version'
        - php -v
        - '# Check Composer version'
        - composer --version || echo "Composer not found, installing..."
        - '# Install PHP dependencies'
        - composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist --no-scripts
        - '# Run post-install scripts'
        - composer dump-autoload --optimize
        - '# Install Node.js dependencies'
        - npm ci || npm install
    build:
      commands:
        - '# Build frontend assets'
        - npm run build
        - '# Copy .env.example to .env if .env doesn't exist'
        - 'if [ ! -f .env ] && [ -f .env.example ]; then cp .env.example .env; fi'
        - '# Generate application key if not exists'
        - php artisan key:generate --force || echo "Key generation skipped"
        - '# Create storage directories if they don't exist'
        - mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views storage/logs
        - mkdir -p bootstrap/cache
        - '# Set proper permissions for storage'
        - chmod -R 775 storage bootstrap/cache || echo "Permission setting skipped"
        - '# Run database migrations automatically'
        - 'if [ -n "$DB_HOST" ] && [ -n "$DB_DATABASE" ]; then echo "Running database migrations..."; php artisan migrate --force || echo "Migration failed or already up to date"; else echo "Database credentials not set, skipping migrations"; fi'
        - '# Optimize Laravel for production'
        - php artisan config:cache || echo "Config cache skipped"
        - php artisan route:cache || echo "Route cache skipped"
        - php artisan view:cache || echo "View cache skipped"
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - vendor/**/*
      - .npm/**/*
